<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture Ninja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            color: #fff; 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation moderne */
        .navbar { 
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.8rem;
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-btn { 
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff; 
            margin: 8px;
            padding: 12px 24px;
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn:hover { 
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .nav-btn.active { 
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        /* Cards modernes */
        .modern-card { 
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin: 20px 0; 
            padding: 25px; 
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .modern-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Boutons modernes */
        .btn-modern { 
            margin: 4px; 
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn-modern:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-modern:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* Liens modernes */
        .modern-link { 
            color: #00d4ff; 
            text-decoration: none; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .modern-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            transition: width 0.3s ease;
        }

        .modern-link:hover::after {
            width: 100%;
        }

        .modern-link:hover { 
            color: #00a8cc; 
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Timer badge moderne */
        .timer-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Messages de succ√®s */
        .success-message {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.4);
            z-index: 1000;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        /* Tables modernes */
        .modern-table {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
        }

        .modern-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 700;
            padding: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .modern-table td {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
        }

        /* Modal moderne */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* Navigation par secteur */
        .sector-nav {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .sector-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            padding: 15px 25px;
            border-radius: 15px;
            transition: all 0.3s ease;
            font-weight: 600;
            cursor: pointer;
        }

        .sector-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .sector-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Breadcrumb moderne */
        .breadcrumb-modern {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(20px);
        }

        .breadcrumb-modern span {
            color: #00d4ff;
            font-weight: 600;
        }

        .breadcrumb-modern .separator {
            color: rgba(255, 255, 255, 0.5);
            margin: 0 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-btn {
                margin: 4px;
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            .modern-card {
                padding: 20px;
                margin: 15px 0;
            }
            
            .sector-nav {
                gap: 10px;
            }
            
            .sector-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand">Capture de Drapeau</span>
            <div class="navbar-nav d-flex flex-row">
                <button class="nav-btn btn" data-tab="map">üó∫Ô∏è Carte</button>
                <button class="nav-btn btn" data-tab="sectors">üìã Liste des Points</button>
                <button class="nav-btn btn" data-tab="kiri-conquest">‚öîÔ∏è Conqu√™te de Kiri</button>
                <button class="nav-btn btn" data-tab="stats">üìä Classement</button>
            </div>
            <div class="navbar-nav d-flex flex-row">
                <span id="user-info" class="text-light me-3 d-none">
                    <i class="fas fa-user"></i> <span id="current-user"></span>
                    <small class="text-muted" id="user-role"></small>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="app.logout()" id="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> D√©connexion
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Breadcrumb moderne -->
        <div id="breadcrumb" class="breadcrumb-modern d-none">
            <span id="breadcrumb-content"></span>
        </div>

        <!-- Onglet Carte -->
        <div id="map-tab" class="tab-content">
            <h2>üó∫Ô∏è Carte</h2>
            
            <!-- Navigation des secteurs -->
            <div class="sector-nav">
                <button class="sector-btn" onclick="app.showSector('S1')">üî• Secteur 1 - Pays du Feu</button>
                <button class="sector-btn" onclick="app.showSector('S2')">üå™Ô∏è Secteur 2 - Pays du Vent</button>
                <button class="sector-btn" onclick="app.showSector('S3')">üéµ Secteur 3 - Pays du Son</button>
                <button class="sector-btn" onclick="app.showSector('S4')">üíß Secteur 4 - Pays de l'Eau</button>
                <button class="sector-btn" onclick="app.showSector('S5')">‚öñÔ∏è Secteur 5 - Pays Neutre</button>
            </div>

            <!-- Affichage des pays du secteur -->
            <div id="sector-countries" class="row"></div>

            <!-- Affichage de la carte du pays -->
            <div id="map-display" class="mt-4 d-none">
                <div class="modern-card">
                    <h3 id="map-country-title"></h3>
                    <div class="map-container">
                        <img id="country-map-image" src="" alt="Carte du pays" class="img-fluid border rounded">
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Liste des Points -->
        <div id="sectors-tab" class="tab-content d-none">
            <h2>üìã Liste des Points</h2>
            
            <!-- Navigation des secteurs -->
            <div class="sector-nav">
                <button class="sector-btn" onclick="app.showSector('S1')">üî• Secteur 1 - Pays du Feu</button>
                <button class="sector-btn" onclick="app.showSector('S2')">üå™Ô∏è Secteur 2 - Pays du Vent</button>
                <button class="sector-btn" onclick="app.showSector('S3')">üéµ Secteur 3 - Pays du Son</button>
                <button class="sector-btn" onclick="app.showSector('S4')">üíß Secteur 4 - Pays de l'Eau</button>
                <button class="sector-btn" onclick="app.showSector('S5')">‚öñÔ∏è Secteur 5 - Pays Neutre</button>
            </div>

            <!-- Affichage des pays du secteur -->
            <div id="sector-countries-list" class="row"></div>

            <!-- Affichage des points du pays -->
            <div id="country-points" class="d-none mt-4">
                <div class="modern-card">
                    <h3 id="country-title"></h3>
                    <div id="points-list"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Conqu√™te de Kiri -->
        <div id="kiri-conquest-tab" class="tab-content d-none">
            <h2>‚öîÔ∏è Conqu√™te de Kiri</h2>
            
            <!-- Sous-onglets pour la conqu√™te -->
            <div class="sector-nav">
                <button class="sector-btn" onclick="app.showKiriTab('attackable')">
                    üéØ Points Attaquables
                </button>
                <button class="sector-btn" onclick="app.showKiriTab('soon-attackable')">
                    ‚è∞ Bient√¥t Attaquables
                </button>
                <button class="sector-btn" onclick="app.showKiriTab('owned')">
                    üè¥ Poss√©d√©s par Kiri
                </button>
            </div>

            <!-- Contenu des sous-onglets -->
            <div id="kiri-attackable" class="kiri-tab-content">
                <div class="modern-card">
                    <h3>üéØ Points Attaquables</h3>
                    <p>Points libres ou dont le timer de protection a expir√© (le point reste captur√© mais peut √™tre attaqu√©)</p>
                    <div id="attackable-points-list"></div>
                </div>
            </div>

            <div id="kiri-soon-attackable" class="kiri-tab-content d-none">
                <div class="modern-card">
                    <h3>‚è∞ Bient√¥t Attaquables</h3>
                    <p>Points dont le timer expire dans les 20 prochaines minutes (le point reste captur√©)</p>
                    <div id="soon-attackable-points-list"></div>
                </div>
            </div>

            <div id="kiri-owned" class="kiri-tab-content d-none">
                <div class="modern-card">
                    <h3>üè¥ Poss√©d√©s par Kiri</h3>
                    <p>Points actuellement contr√¥l√©s par Kiri</p>
                    <div id="owned-points-list"></div>
                </div>
            </div>
        </div>

        <!-- Onglet Classement -->
        <div id="stats-tab" class="tab-content d-none">
            <h2>üìä Classement</h2>
            
            <!-- Statistiques globales -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="modern-card text-center">
                        <h4>üè¥ Kiri</h4>
                        <h2 id="kiri-points">0</h2>
                        <p>Points contr√¥l√©s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="modern-card text-center">
                        <h4>üî• Konoha</h4>
                        <h2 id="konoha-points">0</h2>
                        <p>Points contr√¥l√©s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="modern-card text-center">
                        <h4>üå™Ô∏è Suna</h4>
                        <h2 id="suna-points">0</h2>
                        <p>Points contr√¥l√©s</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="modern-card text-center">
                        <h4>üéµ Oto</h4>
                        <h2 id="oto-points">0</h2>
                        <p>Points contr√¥l√©s</p>
                    </div>
                </div>
            </div>

            <!-- Classement des joueurs Kiri -->
            <div class="modern-card">
                <h3>üèÜ Top Joueurs Kiri (Escouade)</h3>
                <div class="table-responsive">
                    <table class="table table-dark modern-table">
                        <thead>
                            <tr>
                                <th>Rang</th>
                                <th>Joueur</th>
                                <th>Winrate</th>
                                <th>Attaques</th>
                                <th>D√©fenses</th>
                                <th>Points Gagn√©s</th>
                                <th>Points Perdus</th>
                                <th>Net</th>
                            </tr>
                        </thead>
                        <tbody id="kiri-players-table">
                            <!-- Les donn√©es seront g√©n√©r√©es dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Statistiques des factions -->
            <div class="modern-card">
                <h3>üìà Statistiques Globales des Factions</h3>
                <div class="table-responsive">
                    <table class="table table-dark modern-table">
                        <thead>
                            <tr>
                                <th>Faction</th>
                                <th>Points Contr√¥l√©s</th>
                                <th>Attaques R√©ussies</th>
                                <th>D√©fenses R√©ussies</th>
                                <th>Winrate Global</th>
                            </tr>
                        </thead>
                        <tbody id="faction-stats-table">
                            <!-- Les donn√©es seront g√©n√©r√©es dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>üîê Connexion</h3>
            <p>Connectez-vous pour acc√©der au syst√®me de capture</p>
            
            <div class="mb-3">
                <label class="form-label">Nom d'utilisateur :</label>
                <input type="text" class="form-control" id="login-username" placeholder="Votre nom d'utilisateur">
            </div>
            <div class="mb-3">
                <label class="form-label">Mot de passe :</label>
                <input type="password" class="form-control" id="login-password" placeholder="Votre mot de passe">
            </div>
            
           <div class="d-flex gap-2">
               <button class="btn btn-primary btn-modern" onclick="app.login()">
                   üîë Se connecter
               </button>
               <button class="btn btn-outline-secondary btn-modern" onclick="app.loginAsVisitor()">
                   üëÅÔ∏è Simple visiteur
               </button>
           </div>
            
            <div class="mt-3">
                <small class="text-muted">
                    <strong>R√¥les disponibles :</strong><br>
                    üëë G√©n√©ral de la Brume - Acc√®s complet<br>
                    üõ°Ô∏è Capitaine de la Brume - Acc√®s complet<br>
                    ‚öîÔ∏è Bras Droit - Acc√®s complet<br>
                    üèõÔ∏è Pilier - Acc√®s complet<br>
                    üëÅÔ∏è Observateur - Lecture seule<br><br>
                    <strong>Ou cliquez sur "Simple visiteur" pour un acc√®s lecture seule sans compte</strong>
                </small>
            </div>
        </div>
    </div>

    <!--  pour capture directe -->
    <div id="capture-modal" class="modal-overlay d-none">
        <div class="modal-content">
            <h3>üè¥ Capturer Directement</h3>
            <p>Choisissez la faction et la dur√©e de protection</p>
            
            <div class="mb-3">
                <label class="form-label">Faction :</label>
                <select class="form-control" id="capture-faction">
                    <option value="Kiri">üè¥ Kiri</option>
                    <option value="Konoha">üè¥ Konoha</option>
                    <option value="Suna">üè¥ Suna</option>
                    <option value="Oto">üè¥ Oto</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Dur√©e de protection (en minutes) :</label>
                <input type="number" class="form-control" id="capture-duration" value="120" min="1" max="1440">
                <small class="text-muted">Dur√©e par d√©faut : 120 minutes (2 heures)</small>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-modern" onclick="app.handleCapture()">
                    üè¥ Capturer
                </button>
                <button class="btn btn-secondary btn-modern" onclick="app.closeCaptureModal()">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>

    <!--   saisie des escouades -->
    <div id="squad-modal" class="modal-overlay d-none">
        <div class="modal-content">
            <h3>üë• Saisie de l'Escouade</h3>
            <p>Entrez les 5 membres de l'escouade pour cette action :</p>
            
            <!-- S√©lection de faction pour attaque r√©ussie et d√©fense rat√©e -->
            <div id="faction-selection" class="mb-3 d-none">
                <label class="form-label">Nouveau propri√©taire :</label>
                <select class="form-select" id="new-faction">
                    <option value="Kiri"> Kiri</option>
                    <option value="Konoha"> Konoha</option>
                    <option value="Suna"> Suna</option>
                    <option value="Oto"> Oto</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Membre 1 :</label>
                <input type="text" class="form-control" id="member1" placeholder="Nom du joueur">
            </div>
            <div class="mb-3">
                <label class="form-label">Membre 2 :</label>
                <input type="text" class="form-control" id="member2" placeholder="Nom du joueur">
            </div>
            <div class="mb-3">
                <label class="form-label">Membre 3 :</label>
                <input type="text" class="form-control" id="member3" placeholder="Nom du joueur">
            </div>
            <div class="mb-3">
                <label class="form-label">Membre 4 :</label>
                <input type="text" class="form-control" id="member4" placeholder="Nom du joueur">
            </div>
            <div class="mb-3">
                <label class="form-label">Membre 5 :</label>
                <input type="text" class="form-control" id="member5" placeholder="Nom du joueur">
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-modern" onclick="app.confirmSquadAction()">
                    ‚úÖ Confirmer
                </button>
                <button class="btn btn-secondary btn-modern" onclick="app.cancelSquadAction()">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>

    <script>
        class CaptureNinjaApp {
            constructor() {
                this.currentTab = 'map';
                this.currentSector = null;
                this.currentCountry = null;
                this.pendingAction = null;
                this.pendingPointId = null;
                
                // Syst√®me d'authentification
                this.currentUser = null;
                this.currentRole = null;
                this.users = this.initializeUsers();
                
                // Donn√©es des joueurs Kiri avec stats d√©taill√©es
                this.kiriPlayers = new Map();
                
                // Donn√©es persistantes (charg√©es depuis Supabase)
                this.pointsData = {};
                this.factionStats = {};
                
                this.loadAllDataFromDatabase();
                
                this.init();
                
                // D√©marrer le rafra√Æchissement automatique pour les observateurs
                this.startAutoRefresh();
            }

            initializeUsers() {
                // Utilisateurs avec r√¥les et permissions
                return {
                    // Hauts grad√©s - Acc√®s complet
                    'general': { username: 'General', password: 'general', role: 'general', permissions: ['read', 'write', 'admin'] },
                    'captain': { username: 'Captain', password: 'captain', role: 'captain', permissions: ['read', 'write', 'admin'] },
                    'bras': { username: 'Bras', password: 'bras', role: 'bras_droit', permissions: ['read', 'write', 'admin'] },
                    'pilier': { username: 'Pilier', password: 'pilier', role: 'pilier', permissions: ['read', 'write', 'admin'] },
                    
                    // Observateurs - Lecture seule
                    'obs1': { username: 'Obs1', password: 'obs1', role: 'observateur', permissions: ['read'] },
                    'obs2': { username: 'Obs2', password: 'obs2', role: 'observateur', permissions: ['read'] }
                };
            }

            initializeKiriPlayers() {
                // Ladder compl√®tement vide - on repart √† z√©ro
                this.kiriPlayers.clear();
            }

            // Charger TOUTES les donn√©es depuis Supabase
            async loadAllDataFromDatabase() {
                try {
                    // Charger les points
                    const pointsResponse = await fetch('/api/points');
                    const points = await pointsResponse.json();
                    
                    // Organiser les points par pays
                    this.pointsData = {};
                    points.forEach(point => {
                        if (!this.pointsData[point.country]) {
                            this.pointsData[point.country] = [];
                        }
                        this.pointsData[point.country].push(point);
                    });
                    
                    // Charger les joueurs Kiri
                    const playersResponse = await fetch('/api/players');
                    const players = await playersResponse.json();
                    
                    this.kiriPlayers.clear();
                    players.forEach(player => {
                        this.kiriPlayers.set(player.name.toLowerCase(), {
                            name: player.name,
                            winrate: player.winrate,
                            attacks: player.attacks,
                            defenses: player.defenses,
                            pointsWon: player.points_won,
                            pointsLost: player.points_lost,
                            net: player.net
                        });
                    });
                    
                    // Charger les stats des factions
                    const factionStatsResponse = await fetch('/api/faction-stats');
                    const factionStats = await factionStatsResponse.json();
                    
                    this.factionStats = {};
                    factionStats.forEach(stat => {
                        this.factionStats[stat.faction_name] = stat;
                    });
                    
                    console.log('‚úÖ Toutes les donn√©es charg√©es depuis Supabase:', {
                        points: points.length,
                        players: players.length,
                        factions: factionStats.length
                    });
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
                    // Fallback vers les donn√©es par d√©faut
                    this.pointsData = this.initializePointsData();
                    this.initializeKiriPlayers();
                }
            }

            // Sauvegarder un point dans la base de donn√©es
            async savePointToDatabase(point) {
                try {
                    const response = await fetch(`/api/points/${point.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            capturedBy: point.capturedBy,
                            protectionTimer: point.protectionTimer ? point.protectionTimer.toISOString() : null
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('‚úÖ Point sauvegard√©:', result);
                    return result;
                } catch (error) {
                    console.error('‚ùå Erreur lors de la sauvegarde du point:', error);
                    throw error;
                }
            }

            // Sauvegarder un joueur Kiri dans la base de donn√©es
            async savePlayerToDatabase(player) {
                try {
                    const response = await fetch('/api/players', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: player.name,
                            winrate: player.winrate,
                            attacks: player.attacks,
                            defenses: player.defenses,
                            points_won: player.pointsWon,
                            points_lost: player.pointsLost,
                            net: player.net
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    console.log('‚úÖ Joueur sauvegard√©:', player.name);
                } catch (error) {
                    console.error('‚ùå Erreur lors de la sauvegarde du joueur:', error);
                }
            }

            // Sauvegarder l'historique d'un combat dans Supabase
            async saveCombatToDatabase(combatData) {
                try {
                    const response = await fetch('/api/combat-history', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(combatData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    console.log('‚úÖ Combat sauvegard√©:', combatData.point_name);
                } catch (error) {
                    console.error('‚ùå Erreur lors de la sauvegarde du combat:', error);
                }
            }

            // Sauvegarder les stats d'une faction dans Supabase
            async saveFactionStatsToDatabase(factionName, stats) {
                try {
                    const response = await fetch('/api/faction-stats', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            factionName: factionName,
                            ...stats
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    
                    console.log('‚úÖ Stats faction sauvegard√©es:', factionName);
                } catch (error) {
                    console.error('‚ùå Erreur lors de la sauvegarde des stats faction:', error);
                }
            }

            // Rafra√Æchissement automatique pour les observateurs
            startAutoRefresh() {
                // Rafra√Æchir toutes les 30 secondes
                setInterval(async () => {
                    if (this.currentUser === 'Visiteur' || this.currentRole === 'observateur') {
                        await this.loadPointsFromDatabase();
                        this.refreshDisplay();
                    }
                }, 30000); // 30 secondes
            }

            initializePointsData() {
                return {
                    // Secteur 1
                    'Pays du Feu (Konoha)': [
                        { id: 'feu-1', name: 'Clairi√®re vall√©e de la fin', capturedBy: null },
                        { id: 'feu-2', name: 'La Clairi√®re de Konoha', capturedBy: null },
                        { id: 'feu-3', name: 'Le hameau du pays du Feu', capturedBy: null }
                    ],
                    'Pays des Rivi√®res': [
                        { id: 'riv-1', name: 'La tour de la plage', capturedBy: null },
                        { id: 'riv-2', name: 'Le temple du feu', capturedBy: null },
                        { id: 'riv-3', name: 'La Mine', capturedBy: null },
                        { id: 'riv-4', name: 'La Cascade', capturedBy: null },
                        { id: 'riv-5', name: 'La statue qui pleure', capturedBy: null }
                    ],
                    // Secteur 2
                    'Pays du Vent (Suna)': [
                        { id: 'vent-1', name: 'Statue de Jade', capturedBy: null },
                        { id: 'vent-2', name: 'T√™te de Dragon', capturedBy: null },
                        { id: 'vent-3', name: 'Porte du D√©sert', capturedBy: null }
                    ],
                    'Pays des Roches': [
                        { id: 'roches-1', name: 'Pont des mineurs', capturedBy: null },
                        { id: 'roches-2', name: 'Tour noir', capturedBy: null },
                        { id: 'roches-3', name: 'Le Dojo', capturedBy: null },
                        { id: 'roches-4', name: 'Hameau des roches', capturedBy: null },
                        { id: 'roches-5', name: 'Cascade roche', capturedBy: null }
                    ],
                    // Secteur 3
                    'Pays du Son (Oto)': [
                        { id: 'son-1', name: 'Vall√©e de la Mort', capturedBy: null },
                        { id: 'son-2', name: 'Enclave Enneig√©e', capturedBy: null }
                    ],
                    'Pays du Fer': [
                        { id: 'fer-1', name: 'Plaine Enneig√©e', capturedBy: null },
                        { id: 'fer-2', name: 'Arche Glac√©e', capturedBy: null },
                        { id: 'fer-3', name: 'Crat√®re', capturedBy: null },
                        { id: 'fer-4', name: 'Lac du Serpent', capturedBy: null },
                        { id: 'fer-5', name: 'Plaine des Samoura√Øs', capturedBy: null },
                        { id: 'fer-6', name: 'Vestige du d√©voreur', capturedBy: null }
                    ],
                    'Pays des Sources Chaudes': [
                        { id: 'sources-1', name: 'La Vall√©e des geysers', capturedBy: null },
                        { id: 'sources-2', name: 'Mont√©e des sources chaudes', capturedBy: null },
                        { id: 'sources-3', name: 'Le Lac de la Grenouille', capturedBy: null },
                        { id: 'sources-4', name: 'Vall√©e des Pics Br√ªlants', capturedBy: null }
                    ],
                    // Secteur 4
                    'Pays des Cerisiers': [
                        { id: 'cerisiers-1', name: 'Passage du son', capturedBy: null },
                        { id: 'cerisiers-2', name: 'Village des Cerisiers', capturedBy: null },
                        { id: 'cerisiers-3', name: 'Vall√©e du panda', capturedBy: null },
                        { id: 'cerisiers-4', name: 'Dojo du printemps', capturedBy: null },
                        { id: 'cerisiers-5', name: 'Terre de la brume sanglante', capturedBy: null }
                    ],
                    'Pays de l\'Eau(Kiri)': [
                        { id: 'kiri-1', name: 'Kiri1', capturedBy: null },
                        { id: 'kiri-2', name: 'Kiri2', capturedBy: null },
                        { id: 'kiri-3', name: 'Kiri3', capturedBy: null }
                    ],
                    // Secteur 5
                    'Pays des Oiseaux': [
                        { id: 'oiseaux-1', name: 'La Plaine', capturedBy: null },
                        { id: 'oiseaux-2', name: 'La Pente', capturedBy: null },
                        { id: 'oiseaux-3', name: 'La Crois√©e des Mondes', capturedBy: null },
                        { id: 'oiseaux-4', name: 'La Vall√©e', capturedBy: null }
                    ],
                    'Pays du Silence': [
                        { id: 'silence-1', name: 'Passage sans Bruit', capturedBy: null },
                        { id: 'silence-2', name: 'Les Corniches', capturedBy: null },
                        { id: 'silence-3', name: 'Le Secret du Bruit', capturedBy: null },
                        { id: 'silence-4', name: 'Les Ossements', capturedBy: null }
                    ]
                };
            }

            init() {
                this.initNavigation();
                this.updateStats();
                this.showTab('map');
                
                // V√©rifier si l'utilisateur est d√©j√† connect√©
                this.checkAuth();
            }

            // M√©thodes d'authentification
            login() {
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value.trim();
                
                if (!username || !password) {
                    alert('Veuillez remplir tous les champs !');
                    return;
                }
                
                // Chercher l'utilisateur
                const user = Object.values(this.users).find(u => 
                    u.username.toLowerCase() === username.toLowerCase() && u.password === password
                );
                
                if (user) {
                    this.currentUser = user.username;
                    this.currentRole = user.role;
                    
                    // Masquer le modal de login
                    document.getElementById('login-modal').classList.add('d-none');
                    
                    // Afficher les infos utilisateur
                    this.updateUserInterface();
                    
                    // Rafra√Æchir l'affichage selon les permissions
                    this.refreshDisplay();
                    
                    this.showSuccessMessage(`‚úÖ Bienvenue ${user.username} !`);
                } else {
                    alert('‚ùå Nom d\'utilisateur ou mot de passe incorrect !');
                }
            }

            logout() {
                this.currentUser = null;
                this.currentRole = null;
                
                // Masquer les infos utilisateur
                document.getElementById('user-info').classList.add('d-none');
                document.getElementById('logout-btn').style.display = 'none';
                
                // Afficher le modal de login
                document.getElementById('login-modal').classList.remove('d-none');
                
                // Rafra√Æchir l'affichage
                this.refreshDisplay();
                
                this.showSuccessMessage('üëã D√©connexion r√©ussie !');
            }

            loginAsVisitor() {
                // Connexion automatique en tant qu'observateur
                this.currentUser = 'Visiteur';
                this.currentRole = 'observateur';
                
                // Masquer le modal de login
                document.getElementById('login-modal').classList.add('d-none');
                
                // Afficher les infos utilisateur
                this.updateUserInterface();
                
                // Rafra√Æchir l'affichage selon les permissions
                this.refreshDisplay();
                
                this.showSuccessMessage('üëÅÔ∏è Bienvenue en mode visiteur !');
            }

            checkAuth() {
                // Pour l'instant, on affiche toujours le modal de login
                // Dans une vraie app, on v√©rifierait le localStorage ou les cookies
                document.getElementById('login-modal').classList.remove('d-none');
            }

            updateUserInterface() {
                const userInfo = document.getElementById('user-info');
                const currentUserSpan = document.getElementById('current-user');
                const userRoleSpan = document.getElementById('user-role');
                const logoutBtn = document.getElementById('logout-btn');
                
                currentUserSpan.textContent = this.currentUser;
                userRoleSpan.textContent = this.getRoleDisplayName(this.currentRole);
                
                userInfo.classList.remove('d-none');
                logoutBtn.style.display = 'block';
            }

            getRoleDisplayName(role) {
                const roleNames = {
                    'general': 'üëë G√©n√©ral de la Brume',
                    'capitaine': 'üõ°Ô∏è Capitaine de la Brume',
                    'bras_droit': '‚öîÔ∏è Bras Droit',
                    'pilier': 'üèõÔ∏è Pilier',
                    'observateur': 'üëÅÔ∏è Observateur'
                };
                return roleNames[role] || role;
            }

            hasPermission(permission) {
                if (!this.currentUser) return false;
                
                // Cas sp√©cial pour le visiteur
                if (this.currentUser === 'Visiteur' && this.currentRole === 'observateur') {
                    return permission === 'read';
                }
                
                const user = Object.values(this.users).find(u => u.username === this.currentUser);
                return user && user.permissions.includes(permission);
            }

            initNavigation() {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = btn.getAttribute('data-tab');
                        this.showTab(tab);
                    });
                });
            }

            // Nouvelle navigation par secteur
            showSector(sectorId) {
                this.currentSector = sectorId;
                this.currentCountry = null;
                
                // Mettre √† jour les boutons de secteur
                document.querySelectorAll('.sector-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Afficher les pays du secteur
                this.displaySectorCountries(sectorId);
                
                // Mettre √† jour le breadcrumb
                this.updateBreadcrumb();
            }

            displaySectorCountries(sectorId) {
                const countries = this.getCountriesForSector(sectorId);
                const container = this.currentTab === 'map' ? 
                    document.getElementById('sector-countries') : 
                    document.getElementById('sector-countries-list');
                
                container.innerHTML = '';
                
                countries.forEach(country => {
                    const countryDiv = document.createElement('div');
                    countryDiv.className = 'col-md-6 mb-3';
                    countryDiv.innerHTML = `
                        <div class="modern-card">
                            <h5>${country.name}</h5>
                            <p>${country.points} points</p>
                            <button class="btn btn-primary btn-modern" onclick="app.showCountry('${country.name}')">
                                ${this.currentTab === 'map' ? 'üó∫Ô∏è Voir la carte' : 'üìã Voir les points'}
                            </button>
                        </div>
                    `;
                    container.appendChild(countryDiv);
                });
                
                // Masquer l'affichage des points/carte
                if (this.currentTab === 'map') {
                    document.getElementById('map-display').classList.add('d-none');
                } else {
                    document.getElementById('country-points').classList.add('d-none');
                }
            }

            showCountry(countryName) {
                this.currentCountry = countryName;
                this.updateBreadcrumb();
                
                if (this.currentTab === 'map') {
                    this.showMapForCountry(countryName);
                } else {
                    this.showPointsForCountry(countryName);
                }
            }

            updateBreadcrumb() {
                const breadcrumb = document.getElementById('breadcrumb');
                const breadcrumbContent = document.getElementById('breadcrumb-content');
                
                if (this.currentSector && this.currentCountry) {
                    const sectorName = this.getSectorName(this.currentSector);
                    breadcrumbContent.innerHTML = `
                        <span>${sectorName}</span>
                        <span class="separator">></span>
                        <span>${this.currentCountry}</span>
                    `;
                    breadcrumb.classList.remove('d-none');
                } else if (this.currentSector) {
                    const sectorName = this.getSectorName(this.currentSector);
                    breadcrumbContent.innerHTML = `<span>${sectorName}</span>`;
                    breadcrumb.classList.remove('d-none');
                } else {
                    breadcrumb.classList.add('d-none');
                }
            }

            getSectorName(sectorId) {
                const sectorNames = {
                    'S1': 'üî• Secteur 1 - Pays du Feu',
                    'S2': 'üå™Ô∏è Secteur 2 - Pays du Vent',
                    'S3': 'üéµ Secteur 3 - Pays du Son',
                    'S4': 'üíß Secteur 4 - Pays de l\'Eau',
                    'S5': '‚öñÔ∏è Secteur 5 - Pays Neutre'
                };
                return sectorNames[sectorId] || sectorId;
            }

            showTab(tabName) {
                this.currentTab = tabName;
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.add('d-none');
                });
                document.getElementById(`${tabName}-tab`).classList.remove('d-none');
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // R√©initialiser la navigation par secteur
                this.currentSector = null;
                this.currentCountry = null;
                this.updateBreadcrumb();
            }

            // Syst√®me d'escouades
            showSquadModal(actionType, pointId) {
                this.pendingAction = actionType;
                this.pendingPointId = pointId;
                
                // Vider les champs
                for (let i = 1; i <= 5; i++) {
                    document.getElementById(`member${i}`).value = '';
                }
                
                // Afficher/masquer la s√©lection de faction selon l'action
                const factionSelection = document.getElementById('faction-selection');
                if (actionType === 'attack-success' || actionType === 'defense-failed') {
                    factionSelection.classList.remove('d-none');
                } else {
                    factionSelection.classList.add('d-none');
                }
                
                // Afficher le modal
                document.getElementById('squad-modal').classList.remove('d-none');
            }

            confirmSquadAction() {
                const squadMembers = [];
                for (let i = 1; i <= 5; i++) {
                    const member = document.getElementById(`member${i}`).value.trim();
                    if (member) {
                        squadMembers.push(member);
                    }
                }
                
                if (squadMembers.length === 0) {
                    alert('Veuillez entrer au moins un membre de l\'escouade !');
                    return;
                }
                
                // Fermer le modal
                document.getElementById('squad-modal').classList.add('d-none');
                
                // Ex√©cuter l'action
                this.executeCombatAction(this.pendingAction, this.pendingPointId, squadMembers);
                
                // R√©initialiser
                this.pendingAction = null;
                this.pendingPointId = null;
            }

            cancelSquadAction() {
                document.getElementById('squad-modal').classList.add('d-none');
                this.pendingAction = null;
                this.pendingPointId = null;
            }

            async executeCombatAction(actionType, pointId, squadMembers) {
                // Trouver le point dans les donn√©es originales
                const point = this.findPointById(pointId);
                
                if (!point) return;

                // Mettre √† jour les stats des joueurs
                this.updatePlayerStats(squadMembers, actionType, point);

                // Appliquer l'action
                let newFaction = null;
                switch (actionType) {
                    case 'attack-success':
                        newFaction = document.getElementById('new-faction').value;
                        point.capturedBy = newFaction;
                        this.showSuccessMessage(`‚úÖ Attaque r√©ussie ! Point captur√© par ${newFaction} !`);
                        break;
                    case 'attack-failed':
                        this.showSuccessMessage('‚ùå Attaque rat√©e ! Le point reste aux d√©fenseurs.');
                        break;
                    case 'defense-success':
                        this.showSuccessMessage('üõ°Ô∏è D√©fense r√©ussie ! Le point reste aux d√©fenseurs.');
                        break;
                    case 'defense-failed':
                        newFaction = document.getElementById('new-faction').value;
                        point.capturedBy = newFaction;
                        this.showSuccessMessage(`üí• D√©fense rat√©e ! Point captur√© par ${newFaction} !`);
                        break;
                }

                // Ajouter 2h de protection apr√®s chaque action (120 minutes)
                point.protectionTimer = new Date(Date.now() + 2 * 60 * 60 * 1000);

                // Sauvegarder TOUT dans Supabase
                await this.savePointToDatabase(point);
                
                // Sauvegarder chaque joueur mis √† jour
                for (const memberName of squadMembers) {
                    const normalizedName = memberName.toLowerCase();
                    const player = this.kiriPlayers.get(normalizedName);
                    if (player) {
                        await this.savePlayerToDatabase(player);
                    }
                }
                
                // Sauvegarder l'historique du combat
                await this.saveCombatToDatabase({
                    point_id: point.id,
                    point_name: point.name,
                    action_type: actionType,
                    faction: newFaction || point.capturedBy,
                    squad_members: squadMembers,
                    success: actionType.includes('success')
                });

                // Rafra√Æchir l'affichage
                this.refreshDisplay();
            }

            findPointById(pointId) {
                // Chercher dans les donn√©es persistantes
                for (const countryName in this.pointsData) {
                    const points = this.pointsData[countryName];
                    const point = points.find(p => p.id === pointId);
                    if (point) return point;
                }
                return null;
            }

            updatePlayerStats(squadMembers, actionType, point) {
                squadMembers.forEach(memberName => {
                    const normalizedName = memberName.toLowerCase();
                    let player = this.kiriPlayers.get(normalizedName);
                    
                    if (!player) {
                        // Cr√©er un nouveau joueur
                        player = {
                            name: memberName,
                            winrate: 0,
                            attacks: 0,
                            defenses: 0,
                            pointsWon: 0,
                            pointsLost: 0,
                            net: 0,
                            totalActions: 0
                        };
                        this.kiriPlayers.set(normalizedName, player);
                    }
                    
                    // Mettre √† jour les stats selon l'action
                    switch (actionType) {
                        case 'attack-success':
                            player.attacks++;
                            player.pointsWon++;
                            player.net++;
                            break;
                        case 'attack-failed':
                            player.attacks++;
                            player.pointsLost++;
                            player.net--;
                            break;
                        case 'defense-success':
                            player.defenses++;
                            player.pointsWon++;
                            player.net++;
                            break;
                        case 'defense-failed':
                            player.defenses++;
                            player.pointsLost++;
                            player.net--;
                            break;
                    }
                    
                    player.totalActions = player.attacks + player.defenses;
                    if (player.totalActions > 0) {
                        player.winrate = Math.round(((player.pointsWon / player.totalActions) * 100));
                    }
                });
            }

            showPointsForCountry(countryName) {
                document.getElementById('country-points').classList.remove('d-none');
                document.getElementById('country-title').textContent = `Points de ${countryName}`;

                const points = this.getMockPoints(countryName);
                const pointsList = document.getElementById('points-list');
                
                pointsList.innerHTML = '';
                points.forEach(point => {
                    const pointDiv = document.createElement('div');
                    pointDiv.className = 'modern-card';
                    
                    let timerHtml = '';
                    if (point.protectionTimer) {
                        const timerEnd = new Date(point.protectionTimer);
                        const now = new Date();
                        const timeLeft = Math.max(0, timerEnd - now);
                        const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                        const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                        
                        if (timeLeft > 0) {
                            timerHtml = `<p><span class="timer-badge">‚è∞ Protection: ${hoursLeft}h ${minutesLeft}min</span></p>`;
                        }
                    }

                    pointDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5>${point.name}</h5>
                                <p>Statut: ${point.capturedBy || 'Libre'}</p>
                            </div>
                            <div>
                                ${timerHtml}
                            </div>
                        </div>
                        ${this.hasPermission('write') ? `
                        <div class="btn-group mt-3">
                            <button class="btn btn-sm btn-danger btn-modern" onclick="app.showSquadModal('attack-success', '${point.id}')">
                                <i class="fas fa-crosshairs"></i> Attaque R√©ussie
                            </button>
                            <button class="btn btn-sm btn-warning btn-modern" onclick="app.showSquadModal('attack-failed', '${point.id}')">
                                <i class="fas fa-times"></i> Attaque Rat√©e
                            </button>
                            <button class="btn btn-sm btn-success btn-modern" onclick="app.showSquadModal('defense-success', '${point.id}')">
                                <i class="fas fa-shield-alt"></i> D√©fense R√©ussie
                            </button>
                            <button class="btn btn-sm btn-warning btn-modern" onclick="app.showSquadModal('defense-failed', '${point.id}')">
                                <i class="fas fa-times"></i> D√©fense Rat√©e
                            </button>
                            <button class="btn btn-sm btn-primary btn-modern" onclick="app.showCaptureModal('${point.id}')">
                                <i class="fas fa-flag"></i> Capturer Directement
                            </button>
                            <button class="btn btn-sm btn-secondary btn-modern" onclick="app.handleLiberate('${point.id}')">
                                <i class="fas fa-unlock"></i> Lib√©rer
                            </button>
                        </div>
                        ` : `
                        <div class="mt-3">
                            <span class="badge bg-info">
                                <i class="fas fa-eye"></i> Mode Lecture Seule
                            </span>
                        </div>
                        `}
                    `;
                    pointsList.appendChild(pointDiv);
                });
            }

            getMockPoints(countryName) {
                return this.pointsData[countryName] || [];
            }

            getMockPointsOld(countryName) {
                const mockPoints = {
                    // Secteur 1
                    'Pays du Feu (Konoha)': [
                        { id: 'feu-1', name: 'Clairi√®re vall√©e de la fin', capturedBy: 'Konoha', protectionTimer: new Date(Date.now() + 1 * 60 * 60 * 1000) }, // 1h restante
                        { id: 'feu-2', name: 'La Clairi√®re de Konoha', capturedBy: 'Kiri', protectionTimer: new Date(Date.now() + 30 * 60 * 1000) }, // 30min restantes
                        { id: 'feu-3', name: 'Le hameau du pays du Feu', capturedBy: null }
                    ],
                    'Pays des Rivi√®res': [
                        { id: 'riv-1', name: 'La tour de la plage', capturedBy: null },
                        { id: 'riv-2', name: 'Le temple du feu', capturedBy: 'Konoha', protectionTimer: new Date(Date.now() + 45 * 60 * 1000) }, // 45min restantes
                        { id: 'riv-3', name: 'La Mine', capturedBy: null },
                        { id: 'riv-4', name: 'La Cascade', capturedBy: 'Suna', protectionTimer: new Date(Date.now() + 15 * 60 * 1000) }, // 15min restantes
                        { id: 'riv-5', name: 'La statue qui pleure', capturedBy: null }
                    ],
                    
                    // Secteur 2
                    'Pays du Vent (Suna)': [
                        { id: 'vent-1', name: 'Statue de Jade', capturedBy: 'Suna' },
                        { id: 'vent-2', name: 'T√™te de Dragon', capturedBy: null },
                        { id: 'vent-3', name: 'Porte du D√©sert', capturedBy: 'Konoha' }
                    ],
                    'Pays des Roches': [
                        { id: 'roches-1', name: 'Pont des mineurs', capturedBy: null },
                        { id: 'roches-2', name: 'Tour noir', capturedBy: 'Kiri' },
                        { id: 'roches-3', name: 'Le Dojo', capturedBy: null },
                        { id: 'roches-4', name: 'Hameau des roches', capturedBy: 'Suna' },
                        { id: 'roches-5', name: 'Cascade roche', capturedBy: null }
                    ],
                    
                    // Secteur 3
                    'Pays du Son (Oto)': [
                        { id: 'son-1', name: 'Vall√©e de la Mort', capturedBy: 'Oto' },
                        { id: 'son-2', name: 'Enclave Enneig√©e', capturedBy: null }
                    ],
                    'Pays du Fer': [
                        { id: 'fer-1', name: 'Plaine Enneig√©e', capturedBy: null },
                        { id: 'fer-2', name: 'Arche Glac√©e', capturedBy: 'Kiri' },
                        { id: 'fer-3', name: 'Crat√®re', capturedBy: null },
                        { id: 'fer-4', name: 'Lac du Serpent', capturedBy: 'Konoha' },
                        { id: 'fer-5', name: 'Plaine des Samoura√Øs', capturedBy: null },
                        { id: 'fer-6', name: 'Vestige du d√©voreur', capturedBy: 'Suna' }
                    ],
                    'Pays des Sources Chaudes': [
                        { id: 'sources-1', name: 'La Vall√©e des geysers', capturedBy: null },
                        { id: 'sources-2', name: 'Mont√©e des sources chaudes', capturedBy: 'Kiri' },
                        { id: 'sources-3', name: 'Le Lac de la Grenouille', capturedBy: null },
                        { id: 'sources-4', name: 'Vall√©e des Pics Br√ªlants', capturedBy: 'Oto' }
                    ],
                    
                    // Secteur 4
                    'Pays des Cerisiers': [
                        { id: 'cerisiers-1', name: 'Passage du son', capturedBy: null },
                        { id: 'cerisiers-2', name: 'Village des Cerisiers', capturedBy: 'Konoha' },
                        { id: 'cerisiers-3', name: 'Vall√©e du panda', capturedBy: null },
                        { id: 'cerisiers-4', name: 'Dojo du printemps', capturedBy: 'Suna' },
                        { id: 'cerisiers-5', name: 'Point oubli√©', capturedBy: null }
                    ],
                    'Pays de l\'Eau(Kiri)': [
                        { id: 'kiri-1', name: 'Kiri1', capturedBy: 'Kiri' },
                        { id: 'kiri-2', name: 'Kiri2', capturedBy: null },
                        { id: 'kiri-3', name: 'Kiri3', capturedBy: 'Kiri' }
                    ],
                    
                    // Secteur 5
                    'Pays des Oiseaux': [
                        { id: 'oiseaux-1', name: 'La Plaine', capturedBy: null },
                        { id: 'oiseaux-2', name: 'La Pente', capturedBy: 'Konoha' },
                        { id: 'oiseaux-3', name: 'La Crois√©e des Mondes', capturedBy: null },
                        { id: 'oiseaux-4', name: 'La Vall√©e', capturedBy: 'Kiri' }
                    ],
                    'Pays du Silence': [
                        { id: 'silence-1', name: 'Passage sans Bruit', capturedBy: null },
                        { id: 'silence-2', name: 'Les Corniches', capturedBy: 'Suna' },
                        { id: 'silence-3', name: 'Le Secret du Bruit', capturedBy: null },
                        { id: 'silence-4', name: 'Les Ossements', capturedBy: 'Oto' }
                    ]
                };
                return mockPoints[countryName] || [];
            }

            async handleAttackSuccess(pointId) {
                await this.performCombatAction(pointId, 'attack-success');
                this.showSuccessMessage('‚úÖ Attaque r√©ussie !');
            }

            async handleAttackFailed(pointId) {
                await this.performCombatAction(pointId, 'attack-failed');
                this.showSuccessMessage('‚ùå Attaque rat√©e !');
            }

            async handleDefenseSuccess(pointId) {
                await this.performCombatAction(pointId, 'defense-success');
                this.showSuccessMessage('üõ°Ô∏è D√©fense r√©ussie !');
            }

            async handleDefenseFailed(pointId) {
                await this.performCombatAction(pointId, 'defense-failed');
                this.showSuccessMessage('üí• D√©fense rat√©e !');
            }

            showCaptureModal(pointId) {
                this.currentCapturePointId = pointId;
                document.getElementById('capture-modal').classList.remove('d-none');
            }

            closeCaptureModal() {
                document.getElementById('capture-modal').classList.add('d-none');
                this.currentCapturePointId = null;
            }

            async handleCapture() {
                const faction = document.getElementById('capture-faction').value;
                const duration = parseInt(document.getElementById('capture-duration').value);
                
                if (!faction || !duration) {
                    alert('‚ùå Veuillez remplir tous les champs !');
                    return;
                }
                
                // Afficher l'indicateur de chargement
                const captureBtn = document.querySelector('#capture-modal .btn-primary');
                const originalText = captureBtn.innerHTML;
                captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capture en cours...';
                captureBtn.disabled = true;
                
                try {
                    await this.performCombatAction(this.currentCapturePointId, 'capture', faction, duration);
                    this.showSuccessMessage(`üè¥ Point captur√© par ${faction} ! (Protection: ${duration} minutes)`);
                    this.closeCaptureModal();
                } catch (error) {
                    console.error('Erreur lors de la capture:', error);
                    alert('‚ùå Erreur lors de la capture du point');
                } finally {
                    // Restaurer le bouton
                    captureBtn.innerHTML = originalText;
                    captureBtn.disabled = false;
                }
            }

            async handleLiberate(pointId) {
                // Trouver le bouton de lib√©ration et afficher le chargement
                const liberateBtn = document.querySelector(`button[onclick="app.handleLiberate('${pointId}')"]`);
                if (liberateBtn) {
                    const originalText = liberateBtn.innerHTML;
                    liberateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lib√©ration...';
                    liberateBtn.disabled = true;
                    
                    try {
                        await this.performCombatAction(pointId, 'liberate');
                        this.showSuccessMessage('üîì Point lib√©r√© !');
                    } catch (error) {
                        console.error('Erreur lors de la lib√©ration:', error);
                        alert('‚ùå Erreur lors de la lib√©ration du point');
                    } finally {
                        liberateBtn.innerHTML = originalText;
                        liberateBtn.disabled = false;
                    }
                } else {
                    // Fallback si le bouton n'est pas trouv√©
                    await this.performCombatAction(pointId, 'liberate');
                    this.showSuccessMessage('üîì Point lib√©r√© !');
                }
            }

            async performCombatAction(pointId, actionType, faction = null, customDuration = null) {
                // Trouver le point dans toutes les donn√©es
                const allPoints = this.getAllPoints();
                const point = allPoints.find(p => p.id === pointId);
                
                if (!point) return;

                // Appliquer l'action
                switch (actionType) {
                    case 'attack-success':
                        point.capturedBy = 'Kiri';
                        break;
                    case 'defense-success':
                        // Le d√©fenseur garde le point
                        break;
                    case 'attack-failed':
                    case 'defense-failed':
                        // Pas de changement de propri√©taire
                        break;
                    case 'capture':
                        point.capturedBy = faction;
                        break;
                    case 'liberate':
                        point.capturedBy = null;
                        point.protectionTimer = null;
                        break;
                }

                // Ajouter protection apr√®s chaque action (sauf lib√©ration)
                if (actionType !== 'liberate') {
                    // Utiliser la dur√©e personnalis√©e si fournie, sinon 2h par d√©faut
                    const durationMinutes = customDuration || 120;
                    point.protectionTimer = new Date(Date.now() + durationMinutes * 60 * 1000);
                }

                // Rafra√Æchir l'affichage imm√©diatement (UI r√©active)
                this.refreshDisplay();

                // Sauvegarder dans la base de donn√©es en arri√®re-plan (non bloquant)
                this.savePointToDatabase(point).catch(error => {
                    console.error('Erreur lors de la sauvegarde:', error);
                    // Optionnel : afficher une notification d'erreur discr√®te
                });
            }

            getAllPoints() {
                const allPoints = [];
                for (const countryName in this.pointsData) {
                    allPoints.push(...this.pointsData[countryName]);
                }
                return allPoints;
            }

            refreshDisplay() {
                // Rafra√Æchir les statistiques
                this.updateStats();
                
                // Rafra√Æchir la conqu√™te de Kiri si l'onglet est actif
                if (this.currentTab === 'kiri-conquest') {
                    this.updateKiriConquest();
                }
                
                // Rafra√Æchir l'affichage des points si on est dans l'onglet liste des points
                if (this.currentTab === 'sectors' && this.currentCountry) {
                    this.showPointsForCountry(this.currentCountry);
                }
            }

            showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 3000);
            }

            // Fonctions pour l'onglet Carte
            showMapSector(sectorId) {
                const countries = this.getCountriesForSector(sectorId);
                const mapCountries = document.getElementById('map-countries');
                
                mapCountries.innerHTML = '';
                countries.forEach(country => {
                    const countryDiv = document.createElement('div');
                    countryDiv.className = 'col-md-6 mb-3';
                    countryDiv.innerHTML = `
                        <div class="point-card">
                            <h5>${country.name}</h5>
                            <p>${country.points} points</p>
                            <button class="btn btn-primary" onclick="app.showMapForCountry('${country.name}')">
                                Voir la carte
                            </button>
                        </div>
                    `;
                    mapCountries.appendChild(countryDiv);
                });
            }

            getCountriesForSector(sectorId) {
                const sectors = {
                    'S1': [
                        { name: 'Pays du Feu (Konoha)', points: 3 },
                        { name: 'Pays des Rivi√®res', points: 5 }
                    ],
                    'S2': [
                        { name: 'Pays du Vent (Suna)', points: 3 },
                        { name: 'Pays des Roches', points: 5 }
                    ],
                    'S3': [
                        { name: 'Pays du Son (Oto)', points: 2 },
                        { name: 'Pays du Fer', points: 6 },
                        { name: 'Pays des Sources Chaudes', points: 4 }
                    ],
                    'S4': [
                        { name: 'Pays des Cerisiers', points: 5 },
                        { name: 'Pays de l\'Eau(Kiri)', points: 3 }
                    ],
                    'S5': [
                        { name: 'Pays des Oiseaux', points: 4 },
                        { name: 'Pays du Silence', points: 4 }
                    ]
                };
                return sectors[sectorId] || [];
            }

            showMapForCountry(countryName) {
                const mapDisplay = document.getElementById('map-display');
                const mapTitle = document.getElementById('map-country-title');
                const mapImage = document.getElementById('country-map-image');
                
                mapTitle.textContent = `Carte de ${countryName}`;
                
                // Mapping des noms de pays vers les fichiers d'images
                const imageMap = {
                    'Pays du Feu (Konoha)': 'pays_du_feu.png',
                    'Pays des Rivi√®res': 'pays_des_rivieres.png',
                    'Pays du Vent (Suna)': 'pays_du_vent.jpg',
                    'Pays des Roches': 'pays_des_roches.png',
                    'Pays du Son (Oto)': 'pays_du_fer.png', // Pas d'image sp√©cifique, on utilise celle du fer
                    'Pays du Fer': 'pays_du_fer.png',
                    'Pays des Sources Chaudes': 'pays_des_sources_chaudes.png',
                    'Pays des Cerisiers': 'pays_des_cerisiers.png',
                    'Pays de l\'Eau(Kiri)': 'pays_du_feu.png', // Pas d'image sp√©cifique pour Kiri
                    'Pays des Oiseaux': 'pays_des_oiseaux.png',
                    'Pays du Silence': 'pays_du_silence.png'
                };
                
                const imageFile = imageMap[countryName];
                if (imageFile) {
                    mapImage.src = `/images/map/${imageFile}`;
                    mapImage.alt = `Carte de ${countryName}`;
                    mapDisplay.classList.remove('d-none');
                } else {
                    alert(`Image non disponible pour ${countryName}`);
                }
            }

            // Fonctions pour la conqu√™te de Kiri
            showKiriTab(tabType) {
                // Masquer tous les sous-onglets
                document.querySelectorAll('.kiri-tab-content').forEach(tab => {
                    tab.classList.add('d-none');
                });
                
                // Afficher l'onglet s√©lectionn√©
                document.getElementById(`kiri-${tabType}`).classList.remove('d-none');
                
                // Mettre √† jour le contenu
                this.updateKiriConquest();
            }

            updateKiriConquest() {
                this.updateAttackablePoints();
                this.updateSoonAttackablePoints();
                this.updateOwnedPoints();
            }

            updateAttackablePoints() {
                const allPoints = this.getAllPoints();
                const attackablePoints = allPoints.filter(point => {
                    // Points libres ou dont le timer a expir√©
                    return !point.capturedBy || 
                           (point.protectionTimer && new Date() > new Date(point.protectionTimer));
                });

                const container = document.getElementById('attackable-points-list');
                container.innerHTML = '';
                
                attackablePoints.forEach(point => {
                    const pointDiv = document.createElement('div');
                    pointDiv.className = 'modern-card';
                    pointDiv.innerHTML = `
                        <h5>${point.name}</h5>
                        <p>Statut: ${point.capturedBy || 'Libre'}</p>
                        ${this.hasPermission('write') ? `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-danger btn-modern" onclick="app.showSquadModal('attack-success', '${point.id}')">
                                <i class="fas fa-crosshairs"></i> Attaque R√©ussie
                            </button>
                            <button class="btn btn-sm btn-warning btn-modern" onclick="app.showSquadModal('attack-failed', '${point.id}')">
                                <i class="fas fa-times"></i> Attaque Rat√©e
                            </button>
                        </div>
                        ` : `
                        <div class="mt-3">
                            <span class="badge bg-info">
                                <i class="fas fa-eye"></i> Mode Lecture Seule
                            </span>
                        </div>
                        `}
                    `;
                    container.appendChild(pointDiv);
                });
            }

            updateSoonAttackablePoints() {
                const allPoints = this.getAllPoints();
                const soonAttackablePoints = allPoints.filter(point => {
                    if (!point.protectionTimer) return false;
                    
                    const timerEnd = new Date(point.protectionTimer);
                    const now = new Date();
                    const timeLeft = timerEnd - now;
                    
                    // Timer expire dans les 20 prochaines minutes
                    return timeLeft > 0 && timeLeft <= 20 * 60 * 1000;
                });

                const container = document.getElementById('soon-attackable-points-list');
                container.innerHTML = '';
                
                soonAttackablePoints.forEach(point => {
                    const timerEnd = new Date(point.protectionTimer);
                    const now = new Date();
                    const timeLeft = Math.max(0, timerEnd - now);
                    const minutesLeft = Math.ceil(timeLeft / (60 * 1000));
                    
                    const pointDiv = document.createElement('div');
                    pointDiv.className = 'modern-card';
                    pointDiv.innerHTML = `
                        <h5>${point.name}</h5>
                        <p>Contr√¥l√© par: ${point.capturedBy}</p>
                        <p><span class="timer-badge">‚è∞ ${minutesLeft} min restantes</span></p>
                    `;
                    container.appendChild(pointDiv);
                });
            }

            updateOwnedPoints() {
                const allPoints = this.getAllPoints();
                const ownedPoints = allPoints.filter(point => point.capturedBy === 'Kiri');

                const container = document.getElementById('owned-points-list');
                container.innerHTML = '';
                
                ownedPoints.forEach(point => {
                    const pointDiv = document.createElement('div');
                    pointDiv.className = 'modern-card';
                    pointDiv.innerHTML = `
                        <h5>${point.name}</h5>
                        <p>üè¥ Contr√¥l√© par Kiri</p>
                        ${this.hasPermission('write') ? `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success btn-modern" onclick="app.showSquadModal('defense-success', '${point.id}')">
                                <i class="fas fa-shield-alt"></i> D√©fense R√©ussie
                            </button>
                            <button class="btn btn-sm btn-warning btn-modern" onclick="app.showSquadModal('defense-failed', '${point.id}')">
                                <i class="fas fa-times"></i> D√©fense Rat√©e
                            </button>
                        </div>
                        ` : `
                        <div class="mt-3">
                            <span class="badge bg-info">
                                <i class="fas fa-eye"></i> Mode Lecture Seule
                            </span>
                        </div>
                        `}
                    `;
                    container.appendChild(pointDiv);
                });
            }

            // Fonctions pour les statistiques
            updateStats() {
                this.updateFactionPoints();
                this.updateKiriPlayersTable();
                this.updateFactionStatsTable();
            }

            updateFactionPoints() {
                const allPoints = this.getAllPoints();
                const factionCounts = { Kiri: 0, Konoha: 0, Suna: 0, Oto: 0 };
                
                allPoints.forEach(point => {
                    if (point.capturedBy && factionCounts.hasOwnProperty(point.capturedBy)) {
                        factionCounts[point.capturedBy]++;
                    }
                });

                document.getElementById('kiri-points').textContent = factionCounts.Kiri;
                document.getElementById('konoha-points').textContent = factionCounts.Konoha;
                document.getElementById('suna-points').textContent = factionCounts.Suna;
                document.getElementById('oto-points').textContent = factionCounts.Oto;
            }

            updateKiriPlayersTable() {
                const tbody = document.getElementById('kiri-players-table');
                tbody.innerHTML = '';
                
                // Convertir la Map en Array et trier par net (d√©croissant)
                const playersArray = Array.from(this.kiriPlayers.values())
                    .sort((a, b) => b.net - a.net);
                
                if (playersArray.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-trophy"></i> Aucun joueur dans le ladder - Commencez les combats !
                        </td>
                    `;
                    tbody.appendChild(row);
                    return;
                }
                
                playersArray.forEach((player, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.winrate}%</td>
                        <td>${player.attacks}</td>
                        <td>${player.defenses}</td>
                        <td>${player.pointsWon}</td>
                        <td>${player.pointsLost}</td>
                        <td>${player.net >= 0 ? '+' : ''}${player.net}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            updateFactionStatsTable() {
                const tbody = document.getElementById('faction-stats-table');
                tbody.innerHTML = '';
                
                // Toutes les stats √† z√©ro - on repart √† z√©ro
                const factions = [
                    { name: 'Kiri', points: 0, attacks: 0, defenses: 0, winrate: 0 },
                    { name: 'Konoha', points: 0, attacks: 0, defenses: 0, winrate: 0 },
                    { name: 'Suna', points: 0, attacks: 0, defenses: 0, winrate: 0 },
                    { name: 'Oto', points: 0, attacks: 0, defenses: 0, winrate: 0 }
                ];

                // Calculer les points r√©els (qui seront tous √† 0 maintenant)
                const allPoints = this.getAllPoints();
                factions.forEach(faction => {
                    faction.points = allPoints.filter(p => p.capturedBy === faction.name).length;
                });

                factions.forEach(faction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${faction.name}</td>
                        <td>${faction.points}</td>
                        <td>${faction.attacks}</td>
                        <td>${faction.defenses}</td>
                        <td>${faction.winrate}%</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.app = new CaptureNinjaApp();
        });
    </script>
</body>
</html>
